# 授权码停用同步功能说明

## 功能概述

实现了母机停用授权码后，所有使用该授权码的子机立即失效的功能。子机会定期从母机服务器检查授权码状态，如果发现被停用，立即失效并退出程序。

## 功能特点

### 1. 母机服务器端

- **新增API接口**：`/check_license`
  - 接收子机的授权码状态查询请求
  - 检查授权码是否在 `licenses.json` 中被标记为 "revoked"
  - 返回授权码状态（是否被停用）

### 2. 子机客户端

- **启动时检查**：
  - 程序启动时，从母机服务器检查授权码状态
  - 如果授权码被停用，立即显示提示并退出程序
  - 更新本地授权码文件状态为 "revoked"

- **使用中定期检查**：
  - 每5分钟自动从母机服务器检查一次授权码状态
  - 如果发现被停用，立即更新本地状态并退出程序
  - 确保即使程序正在运行，也能及时响应停用操作

- **本地状态检查**：
  - 检查本地授权码文件中的状态标记
  - 如果状态为 "revoked"，立即退出程序

## 工作流程

### 母机停用授权码

1. 母机管理员在授权服务器界面选择授权码
2. 点击"停用选中"按钮
3. 授权码状态在 `licenses.json` 中更新为 "revoked"

### 子机检查授权码状态

1. **启动时检查**：
   - 子机启动时，读取本地授权码
   - 从母机服务器查询授权码状态
   - 如果被停用，显示提示并退出

2. **使用中定期检查**：
   - 每5分钟自动检查一次
   - 如果被停用，更新本地状态并退出

3. **本地状态检查**：
   - 每次更新授权时间显示时，检查本地状态
   - 如果状态为 "revoked"，立即退出

## 技术实现

### 母机服务器端

**文件**：`connection_monitor.py`

1. **新增接口**：`/check_license`
   - 接收POST请求，包含 `license_id`
   - 查询 `licenses.json` 中的授权码状态
   - 返回 `{"status": "success", "revoked": true/false}`

2. **LicenseManager集成**：
   - `ConnectionMonitor` 类中初始化 `LicenseManager`
   - 使用 `get_all_licenses()` 获取所有授权码
   - 检查授权码状态

### 子机客户端

**文件**：`ssh_tool_gui.py`

1. **检查授权码状态方法**：
   ```python
   def check_license_status_from_server(self, license_id: str) -> tuple[bool, bool]:
       # 从母机服务器检查授权码状态
       # 返回 (是否成功, 是否被停用)
   ```

2. **启动时检查**：
   ```python
   def check_license(self) -> bool:
       # 从母机服务器检查授权码状态
       # 如果被停用，更新本地状态并返回False
   ```

3. **使用中定期检查**：
   ```python
   def update_license_time(self):
       # 每5分钟检查一次授权码状态
       # 如果被停用，退出程序
   ```

## 使用说明

### 母机操作

1. 启动母机程序
2. 在授权码列表中选择要停用的授权码
3. 点击"停用选中"按钮
4. 授权码状态更新为 "revoked"

### 子机行为

1. **启动时**：
   - 如果授权码被停用，显示提示并退出
   - 如果授权码有效，正常启动

2. **使用中**：
   - 每5分钟自动检查一次授权码状态
   - 如果被停用，立即退出程序

3. **离线使用**：
   - 如果无法连接到母机服务器，使用本地授权码状态
   - 如果本地状态为 "revoked"，立即退出

## 注意事项

1. **网络要求**：
   - 子机需要能够访问母机服务器的IP地址和端口8888
   - 如果无法连接，子机会使用本地授权码状态

2. **检查频率**：
   - 启动时立即检查
   - 使用中每5分钟检查一次
   - 可以根据需要调整检查频率

3. **停用响应时间**：
   - 最快：启动时检查，立即响应
   - 最慢：使用中检查，最多5分钟响应

4. **离线保护**：
   - 如果子机离线，使用本地授权码状态
   - 一旦授权码被标记为 "revoked"，即使离线也会失效

## 故障排除

1. **子机无法检查授权码状态**：
   - 检查网络连接
   - 检查母机服务器是否运行
   - 检查防火墙设置
   - 检查服务器地址配置

2. **授权码停用后子机仍可使用**：
   - 检查子机是否能连接到母机服务器
   - 检查授权码ID是否正确
   - 等待5分钟让定期检查生效
   - 重启子机程序触发启动时检查

3. **子机频繁检查导致性能问题**：
   - 检查频率已优化为每5分钟一次
   - 可以根据需要调整检查频率


























































